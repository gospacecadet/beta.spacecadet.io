{"version":3,"sources":["meteor://ðŸ’»app/lib/spacecadet-migrator.js","meteor://ðŸ’»app/lib/imported-collections.js","meteor://ðŸ’»app/lib/migrations.beta.spacecadet.io.js"],"names":[],"mappings":"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","file":"/packages/migrations.beta.spacecadet.io.js","sourcesContent":["Migrator = {}\n","Meteor.startup(function(){\n  var importDB = new MongoInternals.RemoteCollectionDriver(Meteor.settings.IMPORT_MONGO_DB_URL);\n\n  _.extend(Migrator, {\n    ImportedStations: new Mongo.Collection('stations', { _driver: importDB }),\n    ImportedUsers: new Mongo.Collection('backupUsers', { _driver: importDB }),\n    ImportedPads: new Mongo.Collection('pads', { _driver: importDB }),\n  })\n});\n","var credentials\n\n_.extend(Migrator, {\n  migrate: function() {\n    if(Mart.Storefronts.find().count() === 0) {\n      credentials = []\n\n      // Migrate Users and Properties\n      _.each(Migrator.ImportedStations.find().fetch(), function(station) {\n        var merchantId = createNewUser(station.userId, station.name)\n        var propertyId = createStorefront(station)\n      })\n\n      // Migrate Spaces\n      _.each(Migrator.ImportedPads.find().fetch(), function(pad) {\n        var spaceId = createProduct(pad)\n      })\n\n      sendEmail()\n    }\n  },\n  forceMigrate: function() {\n    Mart.Storefronts.remove({})\n    Meteor.users.remove({})\n    Mart.Images.remove({})\n    Mart.Products.remove({})\n    Mart.Prices.remove({})\n\n    this.migrate()\n  }\n})\n\nvar sendEmail = function() {\n  var text = \"_id,email,password,property name\\n\"\n\n  _.each(credentials, function(cred) {\n    text = text +\n      cred._id            + \",\" +\n      cred.email          + \",\" +\n      cred.password       + \",\" +\n      cred.propertyName   + \"\\n\"\n  })\n\n  Email.send({\n    from: \"SpaceCadet <do-not-reply@spacecadet.io>\",\n    to: Meteor.settings.EMAIL_RECIPIENTS,\n    subject: \"SpaceCadet Migration Complete\",\n    text: text\n  });\n}\n\nvar createProduct = function(oldProduct) {\n  var newProduct = {\n    _id: oldProduct._id,\n    name: oldProduct.name,\n    description: oldProduct.description,\n    storefrontId: oldProduct.stationId,\n    isPublished: (Meteor.settings.AUTO_PUBLISH === \"true\"),\n    isDeleted: false,\n    size: oldProduct.size,\n    occupancy: oldProduct.occupancy\n  }\n\n  var newProductId = Mart.Products.insert(newProduct, {getAutoValues: false, validate: false})\n\n  if(oldProduct.imagePath) {\n    Mart.Images.insert({\n      objectCollection: \"Products\",\n      objectId: newProductId,\n      index: 1,\n      originalUrl: oldProduct.imagePath,\n      optimizedUrl: oldProduct.imagePath,\n      thumbnailUrl: oldProduct.imagePath\n    }, {validate: false})\n  }\n\n  return newProductId\n}\n\nvar createNewUser = function(oldUserId, propertyName) {\n  var newUser = Meteor.users.findOne(oldUserId)\n\n  if(!newUser) {\n    var oldUser = Migrator.ImportedUsers.findOne(oldUserId)\n    var cred = {\n      _id: oldUserId,\n      email: oldUser.emails[0].address,\n      password: Random.id(),\n    }\n\n    var newUserId = Meteor.users.insert(cred);\n    cred.propertyName = propertyName\n\n    Roles.addUsersToRoles(newUserId, [Mart.ROLES.GLOBAL.MERCHANT], Mart.ROLES.GROUPS.GLOBAL);\n\n    credentials.push(cred)\n    return newUserId\n  }\n\n  return newUser._id\n}\n\nvar createStorefront = function(station) {\n  storefront = {\n    _id: station._id,\n    isPublished: (Meteor.settings.AUTO_PUBLISH === \"true\"),\n    isDeleted: false,\n    userId: station.userId,\n    name: station.name,\n    description: station.description,\n    address: station.address,\n    city: station.city,\n    state: station.state,\n    zip: station.zip,\n    createdAt: new Date()\n  }\n  var storefrontId = Mart.Storefronts.insert(storefront, {getAutoValues: false, validate: false})\n\n  var bannerPath = station.bannerPath\n  var previewPath = station.previewPath || bannerPath\n  bannerPath = bannerPath || previewPath\n\n  if(bannerPath) {\n    Mart.Images.insert({\n      objectCollection: \"Storefronts\",\n      objectId: storefrontId,\n      index: 1,\n      originalUrl: bannerPath,\n      optimizedUrl: bannerPath,\n      thumbnailUrl: previewPath\n    })\n  }\n\n\n  return storefrontId\n}\n"]}